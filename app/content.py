import random
from dataclasses import dataclass
from typing import Optional

@dataclass(frozen=True)
class WordFlashItem:
    item_id: str
    target: str
    options: list[str]
    prompt: Optional[str] = None
    correct: Optional[str] = None

# ---- Темы ----
# В каждой теме: слова по difficulty
THEMES = {
    1: {
        "name": "Школа",
        "easy": [
            "школа","класс","урок","парта","звонок","мел","доска","стол",
            "книга","ручка","пенал","портфель","окно","коридор","здание",
            "форма","стул","листок","сменка","рюкзак"
        ],
        "normal": [
            "тетрадь","учебник","учитель","задание","перемена",
            "карандаш","линейка","дневник","расписание","кабинет",
            "одноклассник","директор","оценка","экзамен","предмет",
            "библиотека","глобус","карта","плакат","лаборатория"
        ],
        "hard": [
            "объяснение","самостоятельность","подготовка","контрольная",
            "исследование","дисциплина","внимательность","успеваемость",
            "образование","конспектирование","аттестация","концентрация",
            "познавательный","аналитический","проектирование",
            "экспериментальный","организация","академический",
            "интеллектуальный","саморазвитие"
        ],
    },

    2: {
        "name": "Животные",
        "easy": [
            "кот","пёс","ёж","заяц","лиса","волк","слон","тигр",
            "утка","жук","рыба","лось","кит","крот","гусь",
            "краб","аист","сом","лев","бык"
        ],
        "normal": [
            "собака","кошка","кролик","лошадь","медведь",
            "воробей","лягушка","черепаха","попугай",
            "дельфин","белка","барсук","антилопа","кенгуру",
            "ястреб","павлин","кальмар","пингвин","енот","осьминог"
        ],
        "hard": [
            "млекопитающее","земноводное","пресмыкающееся","хищник",
            "травоядное","обитание","выживание","миграция",
            "экосистема","размножение","инстинкт","популяция",
            "территориальный","паразитический","симбиоз",
            "адаптация","биоразнообразие","плотоядный",
            "естественный","средаобитания"
        ],
    },

    3: {
        "name": "Природа",
        "easy": [
            "лес","сад","река","поле","снег","дождь","ветер",
            "солнце","трава","гора","луг","камень","песок","ручей",
            "глина","лед","куст","пень","берег","скала"
        ],
        "normal": [
            "радуга","озеро","берёза","ромашка","тропинка",
            "туман","мороз","облако","водопад","рассвет",
            "закат","гроза","поляна","ущелье","долина",
            "равнина","болото","остров","пещера","источник"
        ],
        "hard": [
            "извержение","наводнение","землетрясение",
            "растительность","окружение","климатический",
            "атмосферный","природоведение","вулканический",
            "осадочный","географический","экологический",
            "формирование","преобразование","ландшафтный",
            "цикличность","испарение","конденсация","эрозия","биосфера"
        ],
    },

    4: {
        "name": "Еда",
        "easy": [
            "сок","сыр","хлеб","мёд","чай","суп","рис",
            "лук","соль","груша","пирог","кефир","арбуз","слива",
            "борщ","батон","булка","кекс","дыня","сырник"
        ],
        "normal": [
            "молоко","печенье","компот","котлета","морковка",
            "картофель","карамель","йогурт","омлет","варенье",
            "салат","макароны","сметана","пельмени","колбаса",
            "шоколад","конфета","бутерброд","запеканка","блинчики"
        ],
        "hard": [
            "питательный","калорийность","ингредиенты","приготовление",
            "сервировка","ароматный","кулинарный","маринование",
            "запекание","ферментация","пастеризация","консервирование",
            "дегустация","гастрономический","рецептура","пряность",
            "вегетарианский","диетический","сбалансированный","изысканный"
        ],
    },

    5: {
        "name": "Транспорт",
        "easy": [
            "поезд","метро","такси","лодка","шина","руль",
            "мост","путь","рейс","трос","парус","гараж",
            "катер","кран","вагон","фара","шлюз","тоннель","трактор","платформа"
        ],
        "normal": [
            "автобус","трамвай","самолёт","вертолёт","машина",
            "велосипед","станция","перрон","платформа","шоссе",
            "двигатель","маршрут","экипаж","прицеп","кабина",
            "рейсовый","пассажир","багажник","тормоз","колонна"
        ],
        "hard": [
            "навигация","маршрутизация","перекрёсток","транспортировка",
            "скоростной","регулирование","безопасность","инфраструктура",
            "магистральный","автоматизированный","маневрирование",
            "логистика","эксплуатация","координация","диспетчеризация",
            "аэродинамический","грузоперевозка","сертификация",
            "проектирование","оптимизация"
        ],
    },

    6: {
        "name": "Космос",
        "easy": [
            "луна","марс","звезда","небо","луч","пуск",
            "спутник","комета","орбита","метеор",
            "космос","шлем","шар","сигнал","станция",
            "план","взлёт","скафандр","флаг","пыль"
        ],
        "normal": [
            "планета","ракета","галактика","астероид",
            "космонавт","телескоп","созвездие","модуль",
            "платформа","траектория","обсерватория","движение",
            "поверхность","излучение","капсула","экспедиция",
            "корабль","центр","аппарат","вселенная"
        ],
        "hard": [
            "гравитация","невесомость","притяжение","сверхновая",
            "космология","астрофизика","космический","межпланетный",
            "исследовательский","бесконечность","радиационный",
            "орбитальный","межзвёздный","спектроскопия",
            "экзопланета","колонизация","галактический",
            "наблюдательный","расширение","сингулярность"
        ],
    },

    7: {
        "name": "Спорт",
        "easy": [
            "мяч","гол","бег","лыжи","старт","финиш",
            "матч","судья","форма","клюшка","щит",
            "тур","сетка","шайба","канат","зал","клуб","трек","круг","прыжок"
        ],
        "normal": [
            "футбол","теннис","хоккей","плавание","команда",
            "турнир","тренер","стадион","чемпион","разминка",
            "эстафета","гимнастика","борьба","атлетика",
            "секунда","тайм","награждение","болельщик","сборная","подача"
        ],
        "hard": [
            "соревнование","выносливость","тренировка",
            "результативность","профессиональный","олимпийский",
            "квалификация","регламент","дисциплина","рекордсмен",
            "подготовительный","интенсивность","тактический",
            "стратегический","спортивный","физическаяформа",
            "координация","мобилизация","мотивация","концентрация"
        ],
    },

    8: {
        "name": "Профессии",
        "easy": [
            "врач","повар","шахтёр","пилот","шофёр","дворник",
            "маляр","судья","швея","няня","фермер","кассир",
            "почтальон","рыбак","актёр","пекарь","сторож","слесарь","крановщик","столяр"
        ],
        "normal": [
            "инженер","архитектор","программист","строитель",
            "журналист","дизайнер","менеджер","бухгалтер",
            "переводчик","редактор","воспитатель","фармацевт",
            "электрик","монтажник","следователь","юрист",
            "психолог","ветеринар","аналитик","консультант"
        ],
        "hard": [
            "специализация","квалификация","профессионализм",
            "компетенция","ответственность","сертификация",
            "стажировка","трудоустройство","руководитель",
            "предпринимательство","координация","организационный",
            "должностной","администрирование","производственный",
            "карьерный","перспектива","аттестационный",
            "контрактный","регламентированный"
        ],
    },

    9: {
        "name": "Дом",
        "easy": [
            "дом","крыша","стена","пол","дверь","лампа","ковёр",
            "диван","шкаф","кухня","ванна","чашка",
            "ложка","вилка","кран","печь","замок","окнорама","подвал","чердак"
        ],
        "normal": [
            "квартира","балкон","прихожая","гостиная",
            "спальня","кладовка","лестница","подъезд","комната","корзина","холодильник",
            "микроволновка","пылесос","телевизор","комод",
            "подушка","одеяло","занавеска","розетка"
        ],
        "hard": [
            "интерьер","планировка","благоустройство",
            "коммунальный","электроснабжение","водопровод",
            "вентиляция","конструкция","отопительный",
            "капитальный","изоляция","реконструкция",
            "архитектурный","фасадный","инженерный",
            "эксплуатационный","проектировочный",
            "строительный","ремонтный","обустройство"
        ],
    },

    10: {
        "name": "Музыка",
        "easy": [
            "песня","звук","ритм","нота","хор","бас",
            "флейта","труба","барабан","скрипка",
            "гитара","аккорд","микрофон","сцена",
            "зал","певец","дирижёр","танец","пауза","мелодия"
        ],
        "normal": [
            "оркестр","концерт","композиция","исполнение",
            "репетиция","музыкант","инструмент",
            "аудиозапись","партитура","солист",
            "ансамбль","гармония","альбом","премьера",
            "фонограмма","акустика","аранжировка",
            "творчество","аплодисменты","клавиши"
        ],
        "hard": [
            "импровизация","интерпретация","виртуозность",
            "музыкальный","классический","симфонический",
            "тональность","динамический","экспрессия",
            "профессиональный","художественный",
            "исполнительский","консерватория",
            "композиторский","инструментальный",
            "вокализация","музыковедение","аранжировочный",
            "гармонический","многоголосие"
        ],
    },
}

DEFAULT_THEME_ID = 1

def list_themes():
    return [{"id": tid, "name": t["name"]} for tid, t in sorted(THEMES.items())]

def _pool_for(theme_id: int, difficulty: str) -> list[str]:
    theme = THEMES.get(theme_id) or THEMES[DEFAULT_THEME_ID]
    words = theme.get(difficulty) or theme["normal"]
    return words

def make_word_flash_items(n: int, difficulty: str, theme_id: int, options_k: int = 4) -> list[WordFlashItem]:
    words = _pool_for(theme_id, difficulty)
    pool = words[:]
    random.shuffle(pool)

    # без повторов в рамках сессии, если слов хватает
    if len(pool) >= n:
        pool = pool[:n]

    items: list[WordFlashItem] = []
    for i in range(n):
        target = pool[i % len(pool)]
        distractors = [w for w in words if w != target]
        random.shuffle(distractors)
        options = [target] + distractors[: max(0, options_k - 1)]
        random.shuffle(options)
        items.append(WordFlashItem(item_id=f"wf_t{theme_id}_{difficulty}_{i}", target=target, options=options))
    return items
def make_odd_one_out_items(n: int, difficulty: str, theme_id: int, options_k: int = 4) -> list[WordFlashItem]:
    """Generate 'odd one out' tasks.

    options: list[str] of length options_k (usually 4)
    target: the odd word (must be selected by the player)

    - pick (options_k-1) words from the chosen theme
    - pick 1 word from a different theme
    """
    if options_k < 3:
        options_k = 3

    base_words = _pool_for(theme_id, difficulty)
    base_pool = base_words[:]
    random.shuffle(base_pool)

    other_theme_ids = [tid for tid in THEMES.keys() if tid != theme_id]
    if not other_theme_ids:
        other_theme_ids = [DEFAULT_THEME_ID]

    items: list[WordFlashItem] = []
    for i in range(n):
        group_k = max(2, options_k - 1)
        group = []
        while len(group) < group_k:
            w = base_pool[(i + len(group)) % len(base_pool)]
            if w not in group:
                group.append(w)

        odd_theme_id = random.choice(other_theme_ids)
        odd_words = _pool_for(odd_theme_id, difficulty)
        odd = random.choice([w for w in odd_words if w not in group] or odd_words)

        options = group + [odd]
        options = list(dict.fromkeys(options))
        while len(options) < options_k:
            cand = random.choice([w for w in base_words if w not in options] or base_words)
            options.append(cand)

        options = options[:options_k]
        random.shuffle(options)
        items.append(
            WordFlashItem(
                item_id=f"ooo_t{theme_id}_{difficulty}_{i}",
                target="",  # важно: НЕ показываем ответ на этапе "показа"
                options=options,
                prompt="Выбери лишнее слово",
                correct=odd,
            )
        )
    return items
def make_letter_builder_items(n: int, difficulty: str, theme_id: int) -> list[WordFlashItem]:
    """
    letter_builder:
    - target НЕ показываем (ставим пустую строку)
    - correct = правильное слово (для проверки на фронте)
    - options = перемешанные буквы слова
    """
    words = _pool_for(theme_id, difficulty)
    pool = words[:]
    random.shuffle(pool)

    if len(pool) >= n:
        pool = pool[:n]

    items: list[WordFlashItem] = []
    for i in range(n):
        w = pool[i % len(pool)]
        letters = list(w)
        random.shuffle(letters)

        items.append(
            WordFlashItem(
                item_id=f"lb_t{theme_id}_{difficulty}_{i}",
                target="",               # важно: не показываем слово
                options=letters,          # буквы-кнопки
                prompt=None,              # никаких подсказок
                correct=w,                # правильный ответ
            )
        )
    return items